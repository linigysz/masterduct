<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MASTERDUCT Payroll Software</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .header-logo {
      flex-shrink: 0;
      margin-right: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .header-logo img {
      height: 50px;
      width: auto;
      display: block;
    }
    .header-text {
      flex: 1;
    }
    .header-text h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .header-text p {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 300;
    }
    .content-container {
      padding: 30px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
      overflow: hidden;
    }
    .section-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header h3 {
      color: #495057;
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    .print-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      transition: background 0.3s ease;
    }
    .print-btn:hover {
      background: #5a6268;
    }
    .print-btn svg {
      width: 16px;
      height: 16px;
    }
    .section-content {
      padding: 20px;
    }
    .upload-section {
      text-align: center;
      padding: 30px;
    }
    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 40px 20px;
      background: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .upload-area:hover {
      border-color: #007bff;
      background: #e3f2fd;
    }
    .upload-area.dragover {
      border-color: #28a745;
      background: #d4edda;
    }
    input[type="file"] {
      display: none;
    }
    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s ease;
    }
    .file-input-label:hover {
      background: #0056b3;
    }
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-group label {
      font-weight: 600;
      color: #495057;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    select, input[type="date"], input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    .holiday-controls {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .holiday-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .holiday-entry {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .holiday-entry input {
      min-width: 140px;
      padding: 6px 8px;
      font-size: 13px;
    }
    .holiday-entry button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s ease;
    }
    .add-holiday {
      background: #28a745;
      color: white;
    }
    .add-holiday:hover {
      background: #218838;
    }
    .remove-holiday {
      background: #dc3545;
      color: white;
    }
    .remove-holiday:hover {
      background: #c82333;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      background: white;
      font-size: 13px;
    }
    th, td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      vertical-align: middle;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody tr:hover {
      background: #f8f9fa;
    }
    .sunday-row {
      background-color: #fff5f5 !important;
    }
    .sunday-row:hover {
      background-color: #ffe5e5 !important;
    }
    .table-container {
      max-height: 500px;
      overflow: auto;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }
    .summary-row {
      font-weight: 600;
      background: #e9ecef !important;
      border-top: 2px solid #007bff;
    }
    .salary-calculator {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
    }
    .salary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .salary-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .salary-field label {
      font-weight: 600;
      color: #495057;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .salary-field input {
      padding: 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }
    .salary-field input:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    .salary-field input[readonly] {
      background: linear-gradient(135deg, #f1f3f4 0%, #e8eaf6 100%);
      color: #495057;
      font-weight: 600;
      cursor: not-allowed;
      border-color: #adb5bd;
    }
    .status-message {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: 500;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .hidden {
      display: none;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    .employee-name {
      color: black !important;
    }
    
    /* Print styles */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
      }
      .main-container {
        box-shadow: none !important;
        border-radius: 0 !important;
        max-width: none !important;
      }
      .header {
        background: #f39c12 !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .section {
        box-shadow: none !important;
        page-break-inside: avoid;
      }
      .print-btn {
        display: none !important;
      }
      .table-container {
        max-height: none !important;
        overflow: visible !important;
        border: 1px solid #dee2e6 !important;
      }
      .sunday-row {
        background-color: #fff5f5 !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .summary-row {
        background: #e9ecef !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .salary-calculator {
        background: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      .header-text h1 {
        font-size: 24px;
      }
      .content-container {
        padding: 20px;
      }
      .controls-grid {
        grid-template-columns: 1fr;
      }
      .salary-grid {
        grid-template-columns: 1fr;
      }
      .section-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header Section -->
    <div class="header">
      <div class="header-logo">
        <img src="https://masterduct.ae/assets/images/logo-2.png" alt="MASTERDUCT Logo" />
      </div>
      <div class="header-text">
        <h1>MASTERDUCT PAYROLL SOFTWARE</h1>
        <p>Professional Employee Time & Attendance Management System</p>
      </div>
    </div>

    <div class="content-container">
      <!-- File Upload Section -->
      <div class="section">
        <div class="section-header">
          <h3>üìÅ CSV File Upload</h3>
        </div>
        <div class="section-content" id="uploadSection">
          <div class="upload-section">
            <div class="upload-area" id="uploadArea">
              <div style="margin-bottom: 15px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="#007bff">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                </svg>
              </div>
              <h4 style="margin-bottom: 10px; color: #495057;">Upload Your CSV File</h4>
              <p style="color: #6c757d; margin-bottom: 20px;">Select a CSV file containing employee attendance data</p>
              <form id="csvForm">
                <label for="csvFile" class="file-input-label">
                  Choose File
                </label>
                <input type="file" id="csvFile" name="csvFile" accept=".csv" required />
                <button type="submit" class="btn btn-primary" style="margin-left: 15px;">Upload & Process</button>
              </form>
            </div>
            <div id="message" class="status-message hidden"></div>
          </div>
        </div>
      </div>

      <!-- Controls Section -->
      <div class="section hidden" id="controlsSection">
        <div class="section-header">
          <h3>üîß Filter & Display Controls</h3>
        </div>
        <div class="section-content" id="controlsContent">
          <div class="controls-grid">
            <div class="control-group">
              <label for="sNameFilter">Employee Name</label>
              <select id="sNameFilter">
                <option value="">-- Select Employee --</option>
              </select>
            </div>
            <div class="control-group">
              <label for="fromDate">From Date</label>
              <input type="date" id="fromDate" />
            </div>
            <div class="control-group">
              <label for="toDate">To Date</label>
              <input type="date" id="toDate" />
            </div>
          </div>
          
          <div class="holiday-controls">
            <label style="display: block; margin-bottom: 10px;">üèñÔ∏è Public Holidays</label>
            <div class="holiday-list" id="holidayInputsContainer">
              <div class="holiday-entry">
                <input type="date" class="holiday-date" />
                <button type="button" class="add-holiday" onclick="addHolidayDate()">+ Add</button>
              </div>
            </div>
          </div>

          <div style="margin-top: 20px; text-align: center;">
            <button id="displayBtn" class="btn btn-primary">üìä Display All Data</button>
          </div>
        </div>
      </div>

      <!-- Data Table Section -->
      <div class="section hidden" id="tableSection">
        <div class="section-header">
          <h3>üìã Attendance Data</h3>
          <button class="print-btn" onclick="printSection('tableContent')">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zM5 14H4v-2h1v2zm1 0v2h6v-2H6zm9 0v-2h1v2h-1z" clip-rule="evenodd"></path>
            </svg>
            Print
          </button>
        </div>
        <div class="section-content" id="tableContent">
          <div class="table-container" id="csvTableContainer"></div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="calcBtn" class="btn btn-success">‚è∞ Calculate Work Hours</button>
          </div>
        </div>
      </div>

      <!-- Work Hours Section -->
      <div class="section hidden" id="workHoursSection">
        <div class="section-header">
          <h3>‚è±Ô∏è Work Hours Analysis</h3>
          <button class="print-btn" onclick="printSection('workHoursContent')">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zM5 14H4v-2h1v2zm1 0v2h6v-2H6zm9 0v-2h1v2h-1z" clip-rule="evenodd"></path>
            </svg>
            Print
          </button>
        </div>
        <div class="section-content" id="workHoursContent">
          <div class="table-container" id="hoursTableContainer"></div>
        </div>
      </div>

      <!-- Salary Calculator Section -->
      <div class="section salary-calculator hidden" id="salaryCalculatorContainer">
        <div class="section-header">
          <h3>üí∞ Salary Calculator</h3>
          <button class="print-btn" onclick="printSection('salaryContent')">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zM5 14H4v-2h1v2zm1 0v2h6v-2H6zm9 0v-2h1v2h-1z" clip-rule="evenodd"></path>
            </svg>
            Print
          </button>
        </div>
        <div class="section-content" id="salaryContent">
          <div class="salary-grid">
            <div class="salary-field">
              <label for="monthlySalary">Monthly Salary</label>
              <input type="number" id="monthlySalary" step="0.01" />
            </div>
            <div class="salary-field">
              <label for="basicSalary">Basic Salary</label>
              <input type="number" id="basicSalary" step="0.01" />
            </div>
            <div class="salary-field">
              <label for="noOfLeaves">Number of Leaves</label>
              <input type="number" id="noOfLeaves" min="0" readonly />
            </div>
            <div class="salary-field">
              <label for="leaveAdjustments">Leave Adjustments</label>
              <input type="number" id="leaveAdjustments" min="0" value="0" />
            </div>
            <div class="salary-field">
              <label for="totalDeductableLeave">Total Deductible Leave</label>
              <input type="number" id="totalDeductableLeave" readonly />
            </div>
            <div class="salary-field">
              <label for="overTime">Overtime Hours</label>
              <input type="number" id="overTime" step="0.01" min="0" readonly />
            </div>
            <div class="salary-field">
              <label for="daysInMonth">Days in Month</label>
              <input type="number" id="daysInMonth" min="1" max="31" value="30" />
            </div>
            <div class="salary-field">
              <label for="totalSalaryPayable">üí≥ Total Salary Payable</label>
              <input type="text" id="totalSalaryPayable" readonly />
            </div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="calculateSalaryBtn" class="btn btn-success">üí∞ Calculate Salary</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let csvData = null;
    let csvRows = null;
    let sNameIndex = -1;
    let dateIndex = -1;
    let currentRows = null;

    const sNameFilter = document.getElementById('sNameFilter');
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    const displayBtn = document.getElementById('displayBtn');
    const calcBtn = document.getElementById('calcBtn');
    const salaryCalculatorContainer = document.getElementById('salaryCalculatorContainer');
    const controlsSection = document.getElementById('controlsSection');
    const tableSection = document.getElementById('tableSection');
    const workHoursSection = document.getElementById('workHoursSection');

    // Print function for specific sections
    function printSection(sectionId) {
      const section = document.getElementById(sectionId);
      const header = document.querySelector('.header');
      
      if (!section) {
        alert('Section not found!');
        return;
      }

      // Create a new window for printing
      const printWindow = window.open('', '', 'width=800,height=600');
      
      // Get the current page's CSS
      const styles = Array.from(document.styleSheets)
        .map(styleSheet => {
          try {
            return Array.from(styleSheet.cssRules)
              .map(rule => rule.cssText)
              .join('\n');
          } catch (e) {
            return '';
          }
        })
        .join('\n');

      // Special handling for salary calculator section
      let sectionContent = section.innerHTML;
      if (sectionId === 'salaryContent') {
        // Create a formatted salary report for printing
        const monthlySalary = document.getElementById('monthlySalary').value || 'Not entered';
        const basicSalary = document.getElementById('basicSalary').value || 'Not entered';
        const noOfLeaves = document.getElementById('noOfLeaves').value || '0';
        const leaveAdjustments = document.getElementById('leaveAdjustments').value || '0';
        const totalDeductableLeave = document.getElementById('totalDeductableLeave').value || '0';
        const overTime = document.getElementById('overTime').value || '0';
        const daysInMonth = document.getElementById('daysInMonth').value || '30';
        const totalSalaryPayable = document.getElementById('totalSalaryPayable').value || 'Not calculated';
        
        // Get selected employee and date range for context
        const selectedEmployee = document.getElementById('sNameFilter').value || 'All Employees';
        const fromDate = document.getElementById('fromDate').value || 'Not specified';
        const toDate = document.getElementById('toDate').value || 'Not specified';
        
        sectionContent = `
          <div style="margin-bottom: 30px;">
            <h4 style="color: #495057; margin-bottom: 15px;">üìä Salary Calculation Report</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
              <p><strong>Employee:</strong> ${selectedEmployee}</p>
              <p><strong>Period:</strong> ${fromDate} to ${toDate}</p>
              <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr style="background: #f8f9fa;">
                <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Field</th>
                <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Monthly Salary</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${monthlySalary}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Basic Salary</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${basicSalary}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Number of Leaves</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${noOfLeaves}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Leave Adjustments</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${leaveAdjustments}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Total Deductible Leave</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${totalDeductableLeave}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Overtime Hours</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${overTime}</td>
              </tr>
              <tr>
                <td style="padding: 12px; border: 1px solid #dee2e6;">Days in Month</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">${daysInMonth}</td>
              </tr>
              <tr style="background: #e9ecef; font-weight: bold;">
                <td style="padding: 12px; border: 1px solid #dee2e6; font-size: 16px;">üí≥ Total Salary Payable</td>
                <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-size: 16px; color: #28a745;">${totalSalaryPayable}</td>
              </tr>
            </tbody>
          </table>
          
          <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
            <h5 style="margin-bottom: 10px;">üìã Calculation Formula:</h5>
            <p style="font-size: 14px; color: #495057; margin: 5px 0;">
              <strong>Total Salary = </strong>Monthly Salary - (Total Deductible Leave √ó Monthly Salary √∑ Days in Month) + (Basic Salary √∑ Days in Month √∑ 8 √ó Overtime Hours)
            </p>
            <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
              Note: This calculation is based on the attendance data processed and the parameters entered above.
            </p>
          </div>
        `;
      }

      // Write the print content
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>MASTERDUCT Payroll Software - Print</title>
          <style>
            ${styles}
            body { 
              background: white !important; 
              padding: 20px !important; 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            .main-container { 
              box-shadow: none !important; 
              border-radius: 0 !important; 
              max-width: none !important; 
            }
            .print-btn { display: none !important; }
            .table-container { 
              max-height: none !important; 
              overflow: visible !important; 
            }
            @media print {
              body { margin: 0; padding: 10mm; }
              .section { page-break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <div class="main-container">
            ${header.outerHTML}
            <div class="content-container">
              <div class="section">
                <div class="section-content">
                  ${sectionContent}
                </div>
              </div>
            </div>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Wait for content to load then print
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // Add event listeners for salary calculation
    function calculateTotalSalary() {
      const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
      const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
      const daysInMonth = parseFloat(document.getElementById('daysInMonth').value) || 30;
      const overTime = parseFloat(document.getElementById('overTime').value) || 0;
      const noOfLeaves = parseFloat(document.getElementById('noOfLeaves').value) || 0;
      const leaveAdjustments = parseFloat(document.getElementById('leaveAdjustments').value) || 0;
      
      // Calculate Total Deductable Leave
      const totalDeductableLeave = noOfLeaves - leaveAdjustments;
      document.getElementById('totalDeductableLeave').value = totalDeductableLeave;
      
      // Updated Formula: Monthly Salary - (Total Deductable Leave * Monthly Salary / No of Days in Month) + (Basic Salary / No of Days in Month / 8 * Over Time hrs)
      const leaveDeduction = totalDeductableLeave * monthlySalary / daysInMonth;
      const overtimeBonus = basicSalary / daysInMonth / 8 * overTime;
      const totalSalaryPayable = monthlySalary - leaveDeduction + overtimeBonus;
      
      document.getElementById('totalSalaryPayable').value = totalSalaryPayable.toFixed(2);
    }

    // Add event listeners to recalculate when any field changes - REMOVED AUTO CALCULATION
    // Now salary will only be calculated when button is clicked
    
    // Calculate salary button event listener
    document.getElementById('calculateSalaryBtn').addEventListener('click', calculateTotalSalary);

    function showMessage(text, isError = false) {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
      message.classList.remove('hidden');
    }

    function hideAllSections() {
      controlsSection.classList.add('hidden');
      tableSection.classList.add('hidden');
      workHoursSection.classList.add('hidden');
      salaryCalculatorContainer.classList.add('hidden');
    }

    function addHolidayDate() {
      const container = document.getElementById('holidayInputsContainer');
      const entry = document.createElement('div');
      entry.className = 'holiday-entry';
      entry.innerHTML = `
        <input type="date" class="holiday-date" />
        <button type="button" class="remove-holiday" onclick="this.parentElement.remove()">‚Äì Remove</button>
      `;
      container.appendChild(entry);
    }

    function getPublicHolidayDates() {
      const inputs = document.querySelectorAll('.holiday-date');
      return Array.from(inputs).map(i => i.value).filter(d => d);
    }

    // Function to calculate absent days based on the new formula
    function calculateAbsentDays() {
      const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
      const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
      const selectedEmployee = sNameFilter.value;
      
      if (!fromDate || !toDate || !selectedEmployee) {
        return 0; // No date range selected or no employee selected
      }
      
      const publicHolidayDates = getPublicHolidayDates();
      
      // Create new date objects to avoid mutating the originals
      const currentDate = new Date(fromDate.getTime());
      const endDate = new Date(toDate.getTime());
      
      // Ensure we're working with the start of each day
      currentDate.setHours(0, 0, 0, 0);
      endDate.setHours(0, 0, 0, 0);
      
      let totalDaysInRange = 0;
      let daysWithAnyHoursWorked = 0;
      let excludedDays = 0; // Combined count of Sundays and/or Public holidays (no double counting)
      
      // Track work data to determine which days have any hours worked (not incomplete)
      const workStatusData = {};
      
      // First, collect all work data for the selected employee
      if (currentRows) {
        const headers = csvRows[0].map(h => h.trim().toLowerCase());
        const sJobNoIndex = headers.indexOf('sjobno');
        const timeIndex = headers.indexOf('time');
        const statusIndex = headers.indexOf('attendancestatus');

        if (sJobNoIndex !== -1 && timeIndex !== -1 && statusIndex !== -1) {
          const workData = {};

          for (let i = 1; i < currentRows.length; i++) {
            const row = currentRows[i];
            const sName = row[sNameIndex].trim();
            const sJobNo = row[sJobNoIndex].trim();
            const dateStr = row[dateIndex].trim();
            const timeStr = row[timeIndex].trim();
            const status = row[statusIndex].trim().toLowerCase();
            
            if (sName === selectedEmployee) {
              const key = `${sName}|${sJobNo}|${dateStr}`;
              const dateTime = new Date(`${dateStr} ${timeStr}`);

              if (!workData[key]) {
                workData[key] = { sName, sJobNo, date: dateStr, firstIn: null, lastOut: null, breaks: [] };
              }

              if (status === 'checkin') {
                if (!workData[key].firstIn || dateTime < workData[key].firstIn) {
                  workData[key].firstIn = dateTime;
                }
              } else if (status === 'checkout') {
                if (!workData[key].lastOut || dateTime > workData[key].lastOut) {
                  workData[key].lastOut = dateTime;
                }
              } else if (status === 'breakout') {
                workData[key].breaks.push({ breakOut: dateTime, breakIn: null });
              } else if (status === 'breakin') {
                for (let j = workData[key].breaks.length - 1; j >= 0; j--) {
                  if (workData[key].breaks[j].breakOut && !workData[key].breaks[j].breakIn) {
                    workData[key].breaks[j].breakIn = dateTime;
                    break;
                  }
                }
              }
            }
          }

          // Determine which dates have any hours worked (not incomplete)
          Object.values(workData).forEach(entry => {
            const { date, firstIn, lastOut } = entry;
            
            // A day has "any hours worked" if it has both check-in and check-out with valid sequence
            const hasValidHours = firstIn && lastOut && lastOut > firstIn;
            workStatusData[date] = hasValidHours;
          });
        }
      }
      
      // Now iterate through the date range and apply the formula
      while (currentDate <= endDate) {
        totalDaysInRange++;
        
        // Format date as YYYY-MM-DD to match CSV format
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const isSunday = currentDate.getDay() === 0;
        const isPublicHoliday = publicHolidayDates.includes(dateStr);
        
        // Count excluded days (Sunday and/or Public Holiday) - no double counting
        if (isSunday || isPublicHoliday) {
          excludedDays++;
        }
        
        // Check if this day has any hours worked (not incomplete)
        const hasAnyHoursWorked = workStatusData[dateStr] === true;
        if (hasAnyHoursWorked) {
          daysWithAnyHoursWorked++;
        }
        
        // Move to next day
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      // Apply the formula: Total days - Days with any hours worked (not incomplete) - Excluded days (Sundays and/or Public holidays)
      const absentDays = totalDaysInRange - daysWithAnyHoursWorked - excludedDays;
      
      console.log(`Absent Days Calculation Breakdown:`);
      console.log(`Total days in range: ${totalDaysInRange}`);
      console.log(`Days with any hours worked (not incomplete): ${daysWithAnyHoursWorked}`);
      console.log(`Excluded days (Sundays and/or Public holidays): ${excludedDays}`);
      console.log(`Absent days: ${totalDaysInRange} - ${daysWithAnyHoursWorked} - ${excludedDays} = ${absentDays}`);
      
      return Math.max(0, absentDays); // Ensure non-negative result
    }

    // Updated function to calculate leave days based on incomplete work hours
    function calculateLeaveDays() {
      const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
      const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
      const selectedEmployee = sNameFilter.value;
      
      if (!fromDate || !toDate || !selectedEmployee) {
        return 0; // No date range selected or no employee selected
      }
      
      const publicHolidayDates = getPublicHolidayDates();
      
      // Create new date objects to avoid mutating the originals
      const currentDate = new Date(fromDate.getTime());
      const endDate = new Date(toDate.getTime());
      
      // Ensure we're working with the start of each day
      currentDate.setHours(0, 0, 0, 0);
      endDate.setHours(0, 0, 0, 0);
      
      let totalDaysInRange = 0;
      let excludedDays = 0; // Combined count of Sundays and/or Public holidays (no double counting)
      let daysWithIncompleteHours = 0;
      
      // Track work data to determine incomplete hours
      const workStatusData = {};
      
      // First, collect all work data for the selected employee
      if (currentRows) {
        const headers = csvRows[0].map(h => h.trim().toLowerCase());
        const sJobNoIndex = headers.indexOf('sjobno');
        const timeIndex = headers.indexOf('time');
        const statusIndex = headers.indexOf('attendancestatus');

        if (sJobNoIndex !== -1 && timeIndex !== -1 && statusIndex !== -1) {
          const workData = {};

          for (let i = 1; i < currentRows.length; i++) {
            const row = currentRows[i];
            const sName = row[sNameIndex].trim();
            const sJobNo = row[sJobNoIndex].trim();
            const dateStr = row[dateIndex].trim();
            const timeStr = row[timeIndex].trim();
            const status = row[statusIndex].trim().toLowerCase();
            
            if (sName === selectedEmployee) {
              const key = `${sName}|${sJobNo}|${dateStr}`;
              const dateTime = new Date(`${dateStr} ${timeStr}`);

              if (!workData[key]) {
                workData[key] = { sName, sJobNo, date: dateStr, firstIn: null, lastOut: null, breaks: [] };
              }

              if (status === 'checkin') {
                if (!workData[key].firstIn || dateTime < workData[key].firstIn) {
                  workData[key].firstIn = dateTime;
                }
              } else if (status === 'checkout') {
                if (!workData[key].lastOut || dateTime > workData[key].lastOut) {
                  workData[key].lastOut = dateTime;
                }
              } else if (status === 'breakout') {
                workData[key].breaks.push({ breakOut: dateTime, breakIn: null });
              } else if (status === 'breakin') {
                for (let j = workData[key].breaks.length - 1; j >= 0; j--) {
                  if (workData[key].breaks[j].breakOut && !workData[key].breaks[j].breakIn) {
                    workData[key].breaks[j].breakIn = dateTime;
                    break;
                  }
                }
              }
            }
          }

          // Determine which dates have incomplete hours (missing check-in or check-out)
          Object.values(workData).forEach(entry => {
            const { date, firstIn, lastOut } = entry;
            
            // A day is considered "incomplete" if:
            // 1. Missing check-in (firstIn is null)
            // 2. Missing check-out (lastOut is null) 
            // 3. Both are missing
            const isIncomplete = !firstIn || !lastOut || (firstIn && lastOut && lastOut <= firstIn);
            workStatusData[date] = isIncomplete;
          });
        }
      }
      
      // Now iterate through the date range and apply the formula
      while (currentDate <= endDate) {
        totalDaysInRange++;
        
        // Format date as YYYY-MM-DD to match CSV format
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const isSunday = currentDate.getDay() === 0;
        const isPublicHoliday = publicHolidayDates.includes(dateStr);
        
        // Count excluded days (Sunday and/or Public Holiday) - no double counting
        if (isSunday || isPublicHoliday) {
          excludedDays++;
        }
        
        // Check if this day has incomplete hours (excluding Sundays and public holidays)
        if (!isSunday && !isPublicHoliday) {
          // If no work data exists for this date, or if work data shows incomplete hours
          const hasIncompleteHours = workStatusData[dateStr] === undefined || workStatusData[dateStr] === true;
          if (hasIncompleteHours) {
            daysWithIncompleteHours++;
          }
        }
        
        // Move to next day
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      // Apply the formula: Total days - Excluded days (Sundays and/or Public holidays) - Days with incomplete hours
      const leaveCount = totalDaysInRange - excludedDays - daysWithIncompleteHours;
      
      console.log(`Updated Leave Calculation Breakdown:`);
      console.log(`Total days in range: ${totalDaysInRange}`);
      console.log(`Excluded days (Sundays and/or Public holidays): ${excludedDays}`);
      console.log(`Days with incomplete hours (excluding Sundays & holidays): ${daysWithIncompleteHours}`);
      console.log(`Leave count: ${totalDaysInRange} - ${excludedDays} - ${daysWithIncompleteHours} = ${leaveCount}`);
      
      return Math.max(0, leaveCount); // Ensure non-negative result
    }

    document.getElementById('csvForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const file = document.getElementById('csvFile').files[0];

      // Reset everything
      hideAllSections();
      document.getElementById('csvTableContainer').innerHTML = '';
      document.getElementById('hoursTableContainer').innerHTML = '';
      sNameFilter.innerHTML = '<option value="">-- Select Employee --</option>';
      fromDateInput.value = '';
      toDateInput.value = '';
      document.querySelectorAll('.holiday-date').forEach(input => input.value = '');

      if (file && file.name.endsWith('.csv')) {
        showMessage(`Processing file: ${file.name}...`);
        
        const reader = new FileReader();
        reader.onload = function (event) {
          csvData = event.target.result;
          csvRows = csvData.trim().split("\n").map(row => row.split(","));
          
          const headers = csvRows[0].map(h => h.trim().toLowerCase());
          sNameIndex = headers.indexOf('sname');
          dateIndex = headers.indexOf('date');

          if (sNameIndex !== -1) {
            const sNameSet = new Set();
            for (let i = 1; i < csvRows.length; i++) {
              const val = csvRows[i][sNameIndex].trim();
              if (val) sNameSet.add(val);
            }
            sNameSet.forEach(val => {
              const option = document.createElement('option');
              option.value = val;
              option.textContent = val;
              sNameFilter.appendChild(option);
            });
          }

          showMessage(`‚úÖ Successfully loaded ${csvRows.length - 1} attendance records from ${file.name}`);
          controlsSection.classList.remove('hidden');
          currentRows = csvRows;
        };
        reader.readAsText(file);
      } else {
        showMessage("‚ö†Ô∏è Please upload a valid .csv file.", true);
      }
    });

    displayBtn.addEventListener('click', function () {
      if (csvRows) {
        currentRows = csvRows;
        sNameFilter.value = '';
        fromDateInput.value = '';
        toDateInput.value = '';
        workHoursSection.classList.add('hidden');
        salaryCalculatorContainer.classList.add('hidden');
        displayTable(currentRows);
        tableSection.classList.remove('hidden');
      }
    });

    sNameFilter.addEventListener('change', applyFilters);
    fromDateInput.addEventListener('change', applyFilters);
    toDateInput.addEventListener('change', applyFilters);

    function applyFilters() {
      if (!csvRows) return;
      let filtered = [csvRows[0]];
      const selectedSName = sNameFilter.value;
      const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
      const toDate = toDateInput.value ? new Date(toDateInput.value) : null;

      for (let i = 1; i < csvRows.length; i++) {
        const row = csvRows[i];
        let matchSName = true, matchDate = true;
        if (selectedSName && sNameIndex !== -1) {
          matchSName = row[sNameIndex].trim() === selectedSName;
        }
        if (dateIndex !== -1 && (fromDate || toDate)) {
          const cellDate = new Date(row[dateIndex].trim());
          if (isNaN(cellDate)) {
            matchDate = false;
          } else {
            if (fromDate && cellDate < fromDate) matchDate = false;
            if (toDate && cellDate > toDate) matchDate = false;
          }
        }
        if (matchSName && matchDate) filtered.push(row);
      }

      currentRows = filtered;
      displayTable(filtered);
      workHoursSection.classList.add('hidden');
      salaryCalculatorContainer.classList.add('hidden');
      
      if (filtered.length > 1) {
        tableSection.classList.remove('hidden');
      }
    }

    function displayTable(rows) {
      const container = document.getElementById("csvTableContainer");
      if (rows.length <= 1) {
        container.innerHTML = "<div style='text-align: center; padding: 40px; color: #6c757d;'><h4>üì≠ No Data Found</h4><p>No matching attendance records found for the selected criteria.</p></div>";
        return;
      }

      let html = "<table><thead><tr>";
      rows[0].forEach(h => html += `<th>${h.trim()}</th>`);
      html += "</tr></thead><tbody>";
      for (let i = 1; i < rows.length; i++) {
        html += "<tr>";
        rows[i].forEach(cell => html += `<td>${cell.trim()}</td>`);
        html += "</tr>";
      }
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function getOverlappingMinutes(start, end, rangeStart, rangeEnd) {
      const latestStart = new Date(Math.max(start, rangeStart));
      const earliestEnd = new Date(Math.min(end, rangeEnd));
      return latestStart < earliestEnd ? (earliestEnd - latestStart) / (1000 * 60 * 60) : 0;
    }

    calcBtn.addEventListener('click', function () {
      const container = document.getElementById("hoursTableContainer");
      if (!currentRows || currentRows.length <= 1 || dateIndex === -1 || sNameIndex === -1) {
        container.innerHTML = "<p>Required columns missing or no data to calculate.</p>";
        return;
      }

      const headers = csvRows[0].map(h => h.trim().toLowerCase());
      const sJobNoIndex = headers.indexOf('sjobno');
      const timeIndex = headers.indexOf('time');
      const statusIndex = headers.indexOf('attendancestatus');

      if (sJobNoIndex === -1 || timeIndex === -1 || statusIndex === -1) {
        container.innerHTML = "<p>Missing required columns: sJobNo, Time, or AttendanceStatus.</p>";
        return;
      }

      const workData = {};
      const publicHolidayDates = getPublicHolidayDates();

      for (let i = 1; i < currentRows.length; i++) {
        const row = currentRows[i];
        const sName = row[sNameIndex].trim();
        const sJobNo = row[sJobNoIndex].trim();
        const dateStr = row[dateIndex].trim();
        const timeStr = row[timeIndex].trim();
        const status = row[statusIndex].trim().toLowerCase();
        const key = `${sName}|${sJobNo}|${dateStr}`;
        const dateTime = new Date(`${dateStr} ${timeStr}`);

        if (!workData[key]) {
          workData[key] = { sName, sJobNo, date: dateStr, firstIn: null, lastOut: null, breaks: [] };
        }

        if (status === 'checkin') {
          if (!workData[key].firstIn || dateTime < workData[key].firstIn) {
            workData[key].firstIn = dateTime;
          }
        } else if (status === 'checkout') {
          if (!workData[key].lastOut || dateTime > workData[key].lastOut) {
            workData[key].lastOut = dateTime;
          }
        } else if (status === 'breakout') {
          workData[key].breaks.push({ breakOut: dateTime, breakIn: null });
        } else if (status === 'breakin') {
          // Find the most recent breakOut without a breakIn
          for (let j = workData[key].breaks.length - 1; j >= 0; j--) {
            if (workData[key].breaks[j].breakOut && !workData[key].breaks[j].breakIn) {
              workData[key].breaks[j].breakIn = dateTime;
              break;
            }
          }
        }
      }

      let totalHours = 0, totalOT = 0, absentCount = 0;

      let html = "<table><thead><tr><th>Employee</th><th>Job No</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Hours Worked</th><th>Over Time</th></tr></thead><tbody>";
      Object.values(workData).forEach(entry => {
        const { sName, sJobNo, date, firstIn, lastOut, breaks } = entry;
        let hoursWorked = "-", overtime = "-";
        const dateObj = new Date(date);
        const isSunday = dateObj.getDay() === 0;
        const isPublicHoliday = publicHolidayDates.includes(date);
        let rowClass = (isSunday || isPublicHoliday) ? "sunday-row" : "";

        if (firstIn && lastOut && lastOut > firstIn) {
          // Calculate total time between first check-in and last check-out
          let workDuration = (lastOut - firstIn) / (1000 * 60 * 60);
          
          // Calculate total break time
          let totalBreakTime = 0;
          if (breaks && breaks.length > 0) {
            breaks.forEach(breakPeriod => {
              if (breakPeriod.breakOut && breakPeriod.breakIn && breakPeriod.breakIn > breakPeriod.breakOut) {
                totalBreakTime += (breakPeriod.breakIn - breakPeriod.breakOut) / (1000 * 60 * 60);
              }
            });
          }
          
          // Subtract break time from work duration
          workDuration = workDuration - totalBreakTime;
          
          // Ensure work duration is not negative
          if (workDuration < 0) workDuration = 0;
          
          hoursWorked = workDuration.toFixed(2);
          totalHours += parseFloat(hoursWorked);

          if (isSunday || isPublicHoliday) {
            overtime = workDuration.toFixed(2);
          } else if (workDuration >= 8) {
            const dayStart = new Date(`${date} 00:00`);
            const range1End = new Date(`${date} 06:59`);
            const range2Start = new Date(`${date} 16:01`);
            const range2End = new Date(`${date} 23:59`);
            const ot1 = getOverlappingMinutes(firstIn, lastOut, dayStart, range1End);
            const ot2 = getOverlappingMinutes(firstIn, lastOut, range2Start, range2End);
            overtime = (ot1 + ot2).toFixed(2);
          } else {
            overtime = "0.00";
          }

          totalOT += parseFloat(overtime);
        } else {
          // Count as absent only if not Sunday or public holiday
          if (!isSunday && !isPublicHoliday) {
            absentCount++;
          }
        }

        html += `<tr class="${rowClass}">
          <td><span class="employee-name">${sName}</span></td>
          <td>${sJobNo}</td>
          <td>${date}</td>
          <td>${firstIn ? firstIn.toLocaleTimeString() : "‚ö†Ô∏è Missing"}</td>
          <td>${lastOut ? lastOut.toLocaleTimeString() : "‚ö†Ô∏è Missing"}</td>
          <td>${hoursWorked === "-" ? "‚ö†Ô∏è Incomplete" : hoursWorked + " hrs"}</td>
          <td>${overtime === "-" ? "-" : overtime + " hrs"}</td>
        </tr>`;
      });

      // Calculate leave count using the updated formula
      const totalLeaves = calculateLeaveDays();

      // Calculate absent days using the new formula
      const calculatedAbsentDays = calculateAbsentDays();

      // Add summary row
      html += `<tr class="summary-row">
        <td><strong>üìä TOTALS</strong></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td><strong>Absent Days: ${calculatedAbsentDays}</strong></td>
        <td><strong>${totalHours.toFixed(2)} hrs</strong></td>
        <td><strong>${totalOT.toFixed(2)} hrs</strong></td>
      </tr>`;

      html += "</tbody></table>";
      container.innerHTML = html;

      // Show work hours section and salary calculator
      workHoursSection.classList.remove('hidden');
      salaryCalculatorContainer.classList.remove('hidden');
      
      // Auto-populate salary fields - use absent days value for number of leaves
      document.getElementById('overTime').value = totalOT.toFixed(2);
      document.getElementById('noOfLeaves').value = calculatedAbsentDays; // Use absent days value for leaves
      
      // Clear the total salary field since calculation now requires button click
      document.getElementById('totalSalaryPayable').value = '';
    });
  </script>
</body>
</html>